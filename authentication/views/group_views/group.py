from authentication.models.group import Course, Faculty, Group
from authentication.models.user import User
from authentication.serializers.group import GroupSerializer
from rest_framework.response import Response
from rest_framework import status
from rest_framework.decorators import api_view

@api_view(['GET'])
def get_groups_list(request):
    try:
        groups = Group.objects.all()
        serializer = GroupSerializer(groups, many=True)
        return Response(serializer.data, status=200, content_type="application/json; charset=utf-8")
    except Exception as e:
        return Response({'error': f'–û—à–∏–±–∫–∞: {str(e)}'}, status=500)

@api_view(['POST'])
def add_group(request):
    print("üìå –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", request.data)
    
    name = request.data.get('name')
    students_ids = request.data.get('students', [])
    faculty_id = request.data.get('faculty') 
    course_id = request.data.get('course')

    if not name:
        return Response({'error': '–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'}, status=status.HTTP_400_BAD_REQUEST)
    if not faculty_id or not course_id:
        return Response({'error': '–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∏ –∫—É—Ä—Å'}, status=status.HTTP_400_BAD_REQUEST)

    try:
        group = Group(name=name, faculty=Faculty.objects.get(id=faculty_id), course=Course.objects.get(id=course_id))
        group.save()

        valid_students = User.objects.filter(id__in=students_ids)
        students = sorted(valid_students, key=lambda s: s.username.lower())

        half = len(students) // 2

        for i, student in enumerate(students):
            if i < half:
                student.subGroup = 1
            else:
                student.subGroup = 2
            student.save()


        for student in valid_students:
            student.group = group
            student.save()

        serializer = GroupSerializer(group)
        return Response(serializer.data, status=status.HTTP_201_CREATED)

    except User.DoesNotExist:
        return Response({'error': '–°—Ç—É–¥–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=status.HTTP_404_NOT_FOUND)
    except Faculty.DoesNotExist:
        return Response({'error': '–§–∞–∫—É–ª—å—Ç–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=status.HTTP_404_NOT_FOUND)
    except Course.DoesNotExist:
        return Response({'error': '–ö—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=status.HTTP_404_NOT_FOUND)
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@api_view(['PUT'])
def update_group(request):
    group_id = request.data.get('group_id')
    name = request.data.get('name')
    students_ids = request.data.get('students')
    faculty_id = request.data.get('faculty') 
    course_id = request.data.get('course')
    
    try:
        group = Group.objects.get(id=group_id)

        if name:
            group.name = name

        if students_ids is not None:
            User.objects.filter(group=group).update(group=None)
            valid_students = User.objects.filter(id__in=students_ids)
            for student in valid_students:
                student.group = group
                student.save()

        if faculty_id:
            valid_faculty = Faculty.objects.filter(id=faculty_id)
            group.faculty = valid_faculty.first()
        
        if course_id:
            valid_course = Course.objects.filter(id=course_id)
            group.course = valid_course.first()

        group.save()
        serializer = GroupSerializer(group)
        return Response(serializer.data, status=status.HTTP_200_OK)

    except Group.DoesNotExist:
        return Response({'error': '–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}, status=status.HTTP_404_NOT_FOUND)
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)


@api_view(['POST'])
def delete_group(request):
    group_id = request.data.get('group_id')
    if not group_id:
        return Response({'error': 'ID –≥—Ä—É–ø–ø—ã –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'}, status=400)
    try:
        group = Group.objects.get(id=group_id)
        group.delete()
        return Response({'message': '–ì—Ä—É–ø–ø–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞'}, status=200)
    except Group.DoesNotExist:
        return Response({'error': '–ì—Ä—É–ø–ø–∞–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}, status=404)
    except Exception as e:
        return Response({'error': str(e)}, status=500)